---
sidebar: sidebar
permalink: task_config_telegraf_agent_k8s.html
keywords: telegraf, installation, install, agent, telegraf agent, kubernetes, eks, operator, k8s
summary: Cloud Insights supports Telegraf as its agent for collection of integration data on Kubernetes.  
---

= Configuring the NetApp Kubernetes Monitoring Operator

:toc: macro
:hardbreaks:
:nofooter:
:toclevels: 2
:icons: font
:linkattrs:
:imagesdir: ./media/

[.lead]
Cloud Insights uses a number of components, including link:https://docs.fluentbit.io/manual[Fluent Bit] and link:https://docs.influxdata.com/telegraf/[Telegraf], for collection of Kubernetes data. Telegraf is a plugin-driven server agent that can be used to collect and report metrics, events, and logs. Input plugins are used to collect the desired information into the agent by accessing the system/OS directly, by calling third-party APIs, or by listening to configured streams (i.e. Kafka, statsD, etc). Output plugins are used to send the collected metrics, events, and logs from the agent to Cloud Insights. 

toc::[]

Cloud Insights offers the *NetApp Kubernetes Monitoring Operator* (NKMO) for Kubernetes collection. When adding a data collector, simply choose the "Kubernetes" tile.


image:kubernetes_tile.png[Kubernetes Data Collector Tile]

== Before installing the NetApp Kubernetes Monitoring Operator

.Pre-requisites:

* If you are using a custom or private docker repository, follow the instructions in the Using a custom or private docker repository section
* NetApp Kubernetes Monitoring Operator installation is supported with Kubernetes version 1.20 or greater.
* When Cloud Insights is monitoring the backend storage and Kubernetes is used with the Docker container runtime, Cloud Insights can display pod-to-PV-to-storage mappings and metrics for NFS and iSCSI; other runtimes only show NFS.
* Beginning August 2022, the NetApp Kubernetes Monitoring Operator includes support for Pod Security Policy (PSP). You must upgrade to the latest NetApp Kubernetes Monitoring Operator if your environment uses PSP.
* If you are running on OpenShift 4.6 or higher, you must follow the OpenShift Instructions below in addition to ensuring these pre-requisites are met.
* Monitoring is only installed on Linux nodes
Cloud Insights supports monitoring of Kubernetes nodes that are running Linux, by specifying a Kubernetes node selector that looks for the following Kubernetes labels on these platforms:

|===
|Platform	|Label
|Kubernetes v1.20 and above	|Kubernetes.io/os = linux
|Rancher + cattle.io as orchestration/Kubernetes platform	|cattle.io/os = linux
|===

* The NetApp Kubernetes Monitoring Operator and its dependencies (telegraf, kube-state-metrics, fluentbit, etc.) are not supported on nodes that are running with Arm64 architecture.
* The following commands must be available: curl, kubectl. The docker command is required for an optional installation step. For best results, add these commands to the PATH. Note that kubectl needs to be configured with access to the following kubernetes objects at a minimum: agents, clusterroles, clusterrolebindings, customresourcedefinitions, deployments, namespaces, roles, rolebindings, secrets, serviceaccounts, and services. See here for an example .yaml file with these minimum clusterrole privileges.
* The host you will use for the NetApp Kubernetes Monitoring Operator installation must have kubectl configured to communicate with the target K8s cluster, and have Internet connectivity to your Cloud Insights environment.
* If you are behind a proxy during installation, or when operating the K8s cluster to be monitored, follow the instructions in the Configuring Proxy Support section.
* The NetApp Kubernetes Monitoring Operator installs its own kube-state-metrics to avoid conflict with any other instances.
For accurate audit and data reporting, it is strongly recommended to synchronize the time on the Agent machine using Network Time Protocol (NTP) or Simple Network Time Protocol (SNTP).
* If you are re-deploying the Operator (i.e. you are updating or replacing it), there is no need to create a _new_ API token; you can re-use the previous token.
* Also note that ityou have a recent NetApp Kubernetes Monitoring Operator installed and are using an API access token that is renewable, expiring tokens will automatically be replaced by new/refreshed API access tokens.




////
// ----- PreRequisites Start -----
.Pre-requisites:
[[nkmoversion]]

* Please note the following component versions. These are the current _required_ versions included with the NetApp Kubernetes Monitoring Operator. You will particularly need to note these versions if you are <<using-a-custom-or-private-docker-repository,using a custom or private docker repository>>:

** Telegraf: 1.25.0
** kube-rbac-proxy: v0.13.0
** kube-state-metrics: v2.6.0
** fluent-bit: 1.9.8
** kubernetes-event-exporter: v0.10


* NetApp Kubernetes Monitoring Operator installation is supported with Kubernetes version 1.20 or greater. 
* When Cloud Insights is monitoring the backend storage and Kubernetes is used with the Docker container runtime, Cloud Insights can display pod-to-PV-to-storage mappings and metrics for NFS and iSCSI; other runtimes only show NFS. 
* Beginning August 2022, the NetApp Kubernetes Monitoring Operator includes support for Pod Security Policy (PSP). You must <<upgrading, upgrade>> to the latest NetApp Kubernetes Monitoring Operator if your environment uses PSP.

* If you are running on OpenShift 4.6 or higher, you must follow the *OpenShift Instructions* below in addition to ensuring these pre-requisites are met.

* Monitoring is only installed on Linux nodes
+
Cloud Insights supports monitoring of Kubernetes nodes that are running Linux, by specifying a Kubernetes node selector that looks for the following Kubernetes labels on these platforms:
+
|===
|Platform|Label
|Kubernetes v1.20 and above |Kubernetes.io/os = linux
|Rancher + cattle.io as orchestration/Kubernetes platform |cattle.io/os = linux
|===

* The NetApp Kubernetes Monitoring Operator and its dependencies (telegraf, kube-state-metrics, fluentbit, etc.) are not supported on nodes that are running with Arm64 architecture.

* The following commands must be available: _curl_, _sudo_, _openssl_, _sha256sum_, and _kubectl_. For best results, add these commands to the PATH.

* The host you will use for the NetApp Kubernetes Monitoring Operator installation must have _kubectl_ configured to communicate with the target K8s cluster, and have Internet connectivity to your Cloud Insights environment. If this host requires a proxy to reach Cloud Insights, follow the instructions in the <<configuring-proxy-support,Configuring Proxy Support>> section.

* The NetApp Kubernetes Monitoring Operator installs its own kube-state-metrics to avoid conflict with any other instances. 

* If you are behind a proxy during installation, or when operating the K8s cluster to be monitored, follow the instructions in the <<configuring-proxy-support,Configuring Proxy Support>> section. 

* You must have permissions to create Kubernetes cluster roles and role bindings.

For accurate audit and data reporting, it is strongly recommended to synchronize the time on the Agent machine using *Network Time Protocol (NTP)* or *Simple Network Time Protocol (SNTP)*.
// ----- PreRequisites End -----
////





== Note these before you start

If you are running with a <<configuring-proxy-support,proxy>>, have a <<using-a-custom-or-private-docker-repository,custom repository>>, or are using <<openshift-instructions,OpenShift>>, read the following sections carefully.

If you are upgrading from a previous installation, also read the <<upgrading,Upgrading>> information.

// If you want to verify the installation files before installing the Agent, read about <<verifying-kubernetes-checksums, Verifying Kubernetes Checksums>>.



== Configuring the Operator

In newer versions of the operator, most commonly modified settings can be configured in the _AgentConfiguration_ custom resource. You can edit this resource before deploying the operator by editing the _operator-config.yaml_ file. This file includes commented out examples of some settings. See the list of link:telegraf_agent_k8s_config_options.html[available settings] for the most recent version of the operator.

You can also edit this resource after the operator has been deployed using the following command:

	kubectl -n netapp-monitoring edit AgentConfiguration

To determine if your deployed version of the operator supports AgentConfiguration, run the following command:

	kubectl get crd agentconfigurations.monitoring.netapp.com
 
If you see an “Error from server (NotFound)” message, your operator must be upgraded before you can use the AgentConfiguration.



=== Configuring Proxy Support

There are two places where you may use a proxy in your environment in order to install the NetApp Kubernetes Monitoring Operator. These may be the same or separate proxy systems:

* Proxy needed during execution of the installation code snippet (using "curl") to connect the system where the snippet is executed to your Cloud Insights environment
* Proxy needed by the target Kubernetes cluster to communicate with your Cloud Insights environment


=== Configuring Proxy Support

There are two places where you may use a proxy in your environment in order to install the NetApp Kubernetes Monitoring Operator. These may be the same or separate proxy systems:

* Proxy needed during execution of the installation code snippet (using "curl") to connect the system where the snippet is executed to your Cloud Insights environment
* Proxy needed by the target Kubernetes cluster to communicate with your Cloud Insights environment

If you use a proxy for either or both of these, in order to install the NetApp Kubernetes Operating Monitor you must first ensure that your proxy is configured to allow good communication to your Cloud Insights environment. If you have a proxy and can access Cloud Insights from the server/VM from which you wish to install the Operator, then your proxy is likely configured properly.

For the proxy used to install the NetApp Kubernetes Operating Monitor, before installing the Operator, set the _http_proxy/https_proxy_ environment variables. For some proxy environments, you may also need to set the _no_proxy environment_ variable.

To set the variable(s), perform the following steps on your system *before* installing the NetApp Kubernetes Monitoring Operator:

. Set the _https_proxy_ and/or _http_proxy_ environment variable(s) for the current user:
.. If the proxy being setup does not have Authentication (username/password), run the following command:
+
 export https_proxy=<proxy_server>:<proxy_port>
 
.. If the proxy being setup does have Authentication (username/password), run this command:
+
 export http_proxy=<proxy_username>:<proxy_password>@<proxy_server>:<proxy_port>


////
. Create _/etc/default/telegraf_, and insert definitions for the _https_proxy_ and/or _http_proxy_ variable(s):
+
 https_proxy=<proxy_server>:<proxy_port>
////


For the proxy used for your Kubernetes cluster to communicate with your Cloud Insights environment, install the NetApp Kubernetes Monitoring Operator after reading all of these instructions.

Configure the proxy section of AgentConfiguration in operator-config.yaml before deploying the NetApp Kubernetes Monitoring Operator. 

----
proxy:

   server: <server for proxy>
   port: <port for proxy>
   username: <username for proxy>
   password: <password for proxy> 
 
# In the noproxy section, enter a comma-separated list of
# IP addresses and/or resolvable hostnames that should bypass
# the proxy:

   noproxy: <comma separated list>
   isTelegrafProxyEnabled: true
   isFluentbitProxyEnabled: <true or false> # true if Events Log enabled
   isCollectorsProxyEnabled: <true or false> # true if Network Performance and Map enabled
   isAuProxyEnabled: <true or false> # true if AU enabled 
----



////
// ----- Previous Proxy Instructions -----
To finish the configuration, perform the following steps on the system *after* you have installed the NetApp Kubernetes Monitoring Operator.

First, open the _agent-monitoring-netapp_ file for editing:

 kubectl -n netapp-monitoring edit agent agent-monitoring-netapp

Locate the *spec:* section of this file and add the following code:

----
 proxy:
 
 # If an AU is enabled on your cluster for monitoring 
 # by Cloud Insights, then isAuProxyEnabled should be set to true:
  isAuProxyEnabled: <true or false> 
  
 # If your Operator install is behind a corporate proxy, 
 # isTelegrafProxyEnabled should be set to true:
  isTelegrafProxyEnabled: <true or false>
  
 # If LOGS_COLLECTION is enabled on your cluster for monitoring 
 # by CI, then isFluentbitProxyEnabled should be set to true:
  isFluentbitProxyEnabled: <true or false>
  
 # Set the following values according to your proxy login:
  password: <password for proxy, optional>
  port: <port for proxy>
  server: <server for proxy>
  username: <username for proxy, optional
  
 # In the noProxy section, enter a comma-separated list of 
 # IP addresses and/or resolvable hostnames that should bypass
 # the proxy:
  noProxy: <comma separated list>
----

// ----- Previous Proxy Instructions end -----
////



=== Using a custom or private docker repository

By default, the NetApp Kubernetes Monitoring Operator will pull container images from the Cloud Insights repository. If you have a Kubernetes cluster used as the target for monitoring, and that cluster is configured to only pull container images from a custom or private Docker repository or container registry, you must configure access to the containers needed by the NetApp Kubernetes Monitoring Operator.

Run the “Image Pull Snippet” from the NetApp Monitoring Operator install tile. This command will log into the Cloud Insights repository, pull all image dependencies for the operator, and log out of the Cloud Insights repository. When prompted, enter the provided repository temporary password. This command downloads all images used by the operator, including for optional features. See below for which features these images are used for.

Core Operator Functionality and Kubernetes Monitoring

* netapp-monitoring
* kube-rbac-proxy
* kube-state-metrics
* telegraf
* distroless-root-user

Events Log

* fluent-bit
* kubernetes-event-exporter

Network Performance and Map

* ci-net-observer

Push the operator docker image to your private/local/enterprise docker repository according to your corporate policies. Ensure that the image tags and directory paths to these images in your repository are consistent with those in the Cloud Insights repository.

Edit the monitoring-operator deployment in operator-deployment.yaml, and modify all image references to use your private Docker repository.

 image: <docker repo of the enterprise/corp docker repo>/kube-rbac-proxy:<kube-rbac-proxy version>
 image: <docker repo of the enterprise/corp docker repo>/netapp-monitoring:<version>

Edit the AgentConfiguration in operator-config.yaml to reflect the new docker repo location. Create a new imagePullSecret for your private repository, for more details see _https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/_

 # An optional docker registry where you want docker images to be pulled from as compared to CI's docker registry
 # Please see documentation link here:
 dockerRepo: your.docker.repo/long/path/to/test
 # Optional: A docker image pull secret that maybe needed for your private docker registry
 dockerImagePullSecret: docker-secret-name



////
// ----- Previous Custom Docker Section -----
By default, the NetApp Kubernetes Monitoring Operator config will pull container images from public registries. If you have a Kubernetes cluster used as the target for monitoring, and that cluster is configured to only pull container images from a custom or private Docker repository or container registry, you must configure access to the containers needed by the NetApp Kubernetes Monitoring Operator so the necessary commands can be executed.

Use the following instructions to pre-position container images in your registry and alter the NetApp Kubernetes Monitoring Operator config to access those images. Substitute your chosen installation namespace in the following commands if it differs from the default namespace of “netapp-monitoring”.

. Get the docker secret:

 kubectl -n netapp-monitoring get secret docker -o yaml
 
. Copy/paste the value of _.dockerconfigjson:_ from the output of the above command.

. Decode the docker secret:

 echo <paste from _.dockerconfigjson:_ output above> | base64 -d
 
The output of this will be in the following JSON format:

 { "auths":
   {"docker.<cluster>.cloudinsights.netapp.com" :
     {"username":"<tenant id>",
      "password":"<password which is the CI API token>",
      "auth"    :"<encoded username:password basic auth token. This is internal to docker>"}
   }
 }

Log in to the docker repository:

 docker login docker.<cluster>.cloudinsights.netapp.com (from step #2) -u <username from step #2>
 password: <password from docker secret step above>

Pull the operator docker image from Cloud Insights. Make sure the _netapp-monitoring_ version number is current:

 docker pull docker.<cluster>.cloudinsights.netapp.com/netapp-monitoring:<version>
 docker pull docker.<cluster>.cloudinsights.netapp.com/distroless-root-user:<version>
 
Find the _netapp-monitoring_ <version> field using the following command:
 
 kubectl -n netapp-monitoring describe deployment monitoring-operator | grep -i "image:" |grep netapp-monitoring

Push the operator docker image to your private/local/enterprise docker repository according to your corporate policies.

Download all open source dependencies to your private docker registry. The following open source images need to be downloaded. See the <<before-installing-the-netapp-kubernetes-monitoring-operator,Pre-requisites>> section above for the most current versions of these components:


 docker pull docker.<cluster>.cloudinsights.netapp.com/telegraf:<telegraf version>
 docker pull docker.<cluster>.cloudinsights.netapp.com/kube-rbac-proxy:<kube-rbac-proxy version>
 docker pull docker.<cluster>.cloudinsights.netapp.com/kube-state-metrics:<kube-state-metrics version>
 
If fluent-bit is enabled, also download:

 docker pull docker.<cluster>.cloudinsights.netapp.com/fluent-bit:<fluent-bit version>
 docker pull docker.<cluster>.cloudinsights.netapp.com/kubernetes-event-exporter:<kubernetes-event-exporter version>

Edit the monitoring-operator deployment, and modify all image references to use the new docker repo location:

 image: <docker repo of the enterprise/corp docker repo>/kube-rbac-proxy:<kube-rbac-proxy version>
 image: <docker repo of the enterprise/corp docker repo>/netapp-monitoring:<version>

Edit the agent CR to reflect the new docker repo location.

 kubectl -n netapp-monitoring edit agent agent-monitoring-netapp

 docker-repo: <docker repo of the enterprise/corp docker repo>
 dockerRepoSecret: <optional: name of the docker secret of enterprise/corp docker repo, this secret should be already created on the k8s cluster in the same namespace> 

In the _spec:_ section, make the following changes:
 
 spec:
   telegraf:
     - name: ksm
       substitutions:
         - key: k8s.gcr.io
           value: <same as "docker-repo" field above>
// ----- Previous custom docker section end -----
////



=== OpenShift Instructions

If you are running on OpenShift 4.6 or higher, you must edit the AgentConfiguration in _operator-config.yaml_ to enable the _runPrivileged_ setting: 

 # Set runPrivileged to true SELinux is enabled on your kubernetes nodes
 runPrivileged: true

Openshift may implement an added level of security that may block access to some Kubernetes components.

=== Advanced Tuning

For a small subset of advanced settings which cannot be set in AgentConfiguration or outdated operators which do not support AgentConfiguration they can be set in the Agent custom resource. For instructions and lists of the variables you can tune, see the README file included with the operator image. After you have installed the operator, use the following command to view the README:

 kubectl exec -c manager -it <operator-pod-name> -n <namespace> -- cat configs/substitution-vars/README.txt

   


== Installing the NetApp Kubernetes Monitoring Operator

//image:Kubernetes_Operator_Agent_Instructions.png[Operator-Based Install]
//image:NKMO_Install_Instructions.png[Operator-Based Install]
image:NKMO-Instructions-1.png.png[]
image:NKMO-Instructions-2.png.png[]


.Steps to install NetApp Kubernetes Monitoring Operator agent on Kubernetes:

. Enter a unique cluster name and namespace. If you are <<upgrading, upgrading>> from the script-based agent or a previous Kubernetes Operator, use the same cluster name and namespace. 
. Once these are entered, you can copy the Agent Installer snippet
. Click the button to copy this snippet to the clipboard.
. Paste the snippet into a _bash_ window and execute it. Note that the snippet has a unique key and is valid for 24 hours.
. The installation proceeds automatically. When it is complete, click the _Complete Setup_ button.


NOTE: Setup is incomplete until you <<configuring-proxy-support, configure your proxy>>.

NOTE: If you have a custom repository, you must follow the instructions for <<using-a-custom-or-private-docker-repository, Using a custom/private docker repository>>.

Kubernetes EMS log collection is enabled by default when installing the NetApp Kubernetes Monitoring Operator. To disable this collection following installation, click the *Modify Deployment* button at the top of the Kubernetes cluster detail page, and un-select "Log collection". 

image:K8s_Modify_Deployment_Screen.png[Modify Deployment screen showing checkbox for "log Collection"]

This screen also shows current Log Collection status. Below are the possible states:

* Disabled
* Enabled
* Enabled - Installation in progress
* Enabled - Offline
* Enabled - Online
* Error - API Key has insufficient permissions



== Upgrading 

NOTE: If you have a previously installed script-based agent, you _must_ upgrade to the NetApp Kubernetes Monitoring Operator.

=== Upgrading from script-based agent to NetApp Kubernetes Monitoring Operator

To upgrade the telegraf agent, do the following:

. Make note of your cluster name as recognized by Cloud Insights.  You can view the cluster name by running the following command. If your namespace is not the default (_ci-monitoring_), substitute the appropriate namespace:

 kubectl -n ci-monitoring get cm telegraf-conf -o jsonpath='{.data}' |grep "kubernetes_cluster ="
 

////
. Back up the existing configurations:

 kubectl --namespace ci-monitoring get cm -o yaml > /tmp/telegraf-configs.yaml
////


. Save the K8s cluster name for use during installation of the K8s operator-based monitoring solution to ensure data continuity.
+
If you do not remember the name of the K8s cluster in CI, it can be extracted from your saved configuration with the following command line:
+
 cat /tmp/telegraf-configs.yaml | grep kubernetes_cluster | head -2
 
. Remove the script-based monitoring 
+
To uninstall the script-based agent on Kubernetes, do the following:
+
If the monitoring namespace is being used solely for Telegraf:
+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
+
 kubectl delete ns ci-monitoring
+
If the monitoring namespace is being used for other purposes in addition to Telegraf:
+
 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
////


. <<installing-the-netapp-kubernetes-monitoring-operator, Install>> the current Operator. Be sure to use the same cluster name noted in step 1 above.


//image:KubernetesOperatorTile.png[Tile for Kubernetes Operator]



=== Upgrading to the latest NetApp Kubernetes Monitoring Operator

Determine whether an AgentConfiguration exists with the existing Operator (if your namespace is not the default _netapp-monitoring_, substitute the appropriate namespace):

 kubectl -n netapp-monitoring get agentconfiguration netapp-monitoring-configuration
 
If an AgentConfiguration exists:

* <<installing-the-netapp-kubernetes-monitoring-operator,Install>> the latest Operator over the existing Operator.

** Ensure you are <<using-a-custom-or-private-docker-repository,pulling the latest container images>> if you are using a custom repository.

If the AgentConfiguration does not exist:

* Make note of your cluster name as recognized by Cloud Insights (if your namespace is not the default netapp-monitoring, substitute the appropriate namespace):

kubectl -n netapp-monitoring get agent -o jsonpath='{.items[0].spec.cluster-name}'

* Create a backup of the existing Operator (if your namespace is not the default netapp-monitoring, substitute the appropriate namespace):
  
 kubectl -n netapp-monitoring get agent -o yaml > agent_backup.yaml

* <<to-remove-the-netapp-kubernetes-monitoring-operator,Uninstall>> the existing Operator.
* <<installing-the-netapp-kubernetes-monitoring-operator,Install>> the latest Operator.
** Use the same cluster name.
** After downloading the latest Operator YAML files, port any customizations found in agent_backup.yaml to the downloaded operator-config.yaml before deploying.
** Ensure you are <<using-a-custom-or-private-docker-repository,pulling the latest container images>> if you are using a custom repository.



 
== Stopping and Starting the Netapp Kubernetes Monitoring Operator
 
To stop the Netapp Kubernetes Monitoring Operator:

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=0

To start the Netapp Kubernetes Monitoring Operator:

 kubectl -n netapp-monitoring scale deploy monitoring-operator --replicas=1






== Uninstalling

NOTE: If you are running on a previously-installed script-based Kubernetes agent, you must <<upgrading, upgrade>> to the NetApp Kubernetes Monitoring Operator.



=== To remove the deprecated script-based agent

Note that these commands are using the default namespace "ci-monitoring".  If you have set your own namespace, substitute that namespace in these and all subsequent commands and files.

To uninstall the script-based agent on Kubernetes (for example, when upgrading to the NetApp Kubernetes Monitoring Operator), do the following:

If the monitoring namespace is being used solely for Telegraf:

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf
 
 kubectl delete ns ci-monitoring

//For the commands above, use “_netapp-monitoring_” if you installed using operator-based installation with the default namespace.
 
If the monitoring namespace is being used for other purposes in addition to Telegraf:

 kubectl --namespace ci-monitoring delete ds,rs,cm,sa,clusterrole,clusterrolebinding -l app=ci-telegraf



=== To remove the NetApp Kubernetes Monitoring Operator


Note that the default namespace for the NetApp Kubernetes Monitoring Operator is "netapp-monitoring".  If you have set your own namespace, substitute that namespace in these and all subsequent commands and files.

Newer versions of the monitoring operator can be uninstalled with the following commands:


 kubectl delete agent -A -l installed-by=nkmo-<name-space>
 kubectl delete ns,clusterrole,clusterrolebinding,crd -l installed-by=nkmo-<name-space>


If the first command returns “No resources found”, use the following instructions to uninstall older versions of the monitoring operator.

Execute each of the following commands in order. Depending on your current installation, some of these commands may return ‘object not found’ messages. These messages may be safely ignored.

  kubectl -n <NAMESPACE> delete agent agent-monitoring-netapp
  kubectl delete crd agents.monitoring.netapp.com
  kubectl -n <NAMESPACE> delete role agent-leader-election-role  
  kubectl delete clusterrole agent-manager-role agent-proxy-role agent-metrics-reader <NAMESPACE>-agent-manager-role <NAMESPACE>-agent-proxy-role <NAMESPACE>-cluster-role-privileged
  kubectl delete clusterrolebinding agent-manager-rolebinding agent-proxy-rolebinding agent-cluster-admin-rolebinding <NAMESPACE>-agent-manager-rolebinding <NAMESPACE>-agent-proxy-rolebinding <NAMESPACE>-cluster-role-binding-privileged
  kubectl delete <NAMESPACE>-psp-nkmo
  kubectl delete ns <NAMESPACE>


If a Security Context Constraint was previously-created manually for a script-based Telegraf installation:

 kubectl delete scc telegraf-hostaccess
 
 

== About Kube-state-metrics

The NetApp Kubernetes Monitoring Operator installs kube-state-metrics automatically; no user interaction is needed.

//NOTE: Note that with kube-state-metrics version 2.0 and above, Kubernetes object labels are not exported by default. To configure kube-state-metrics to export Kubernetes object labels, you must specify a metric labels "allow" list. Refer to the _--metric-labels-allowlist_ option in the link:https://github.com/kubernetes/kube-state-metrics/blob/master/docs/cli-arguments.md[kube-state-metrics documentation]. 


=== kube-state-metrics Counters


Use the following links to access information for these kube state metrics counters:

. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/configmap-metrics.md[ConfigMap Metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/daemonset-metrics.md[DaemonSet Metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/deployment-metrics.md[Deployment Metrics]
//. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/endpoint-metrics.md[Endpoint Metrics]
//. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/horizontalpodautoscaler-metrics.md[Horizontal Pod Autoscaler Metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/ingress-metrics.md[Ingress Metrics]
//. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/ingress-metrics.md[Job Metrics]
//. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/limitrange-metrics.md[LimitRange Metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/namespace-metrics.md[Namespace Metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/node-metrics.md[Node Metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolume-metrics.md[Persistent Volume Metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/persistentvolumeclaim-metrics.md[Persistant Volume Claim Metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/pod-metrics.md[Pod Metrics]
//. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/poddisruptionbudget-metrics.md[Pod Disruption Budget Metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/replicaset-metrics.md[ReplicaSet metrics]
//. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/replicationcontroller-metrics.md[ReplicationController Metrics]   
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/secret-metrics.md[Secret metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/service-metrics.md[Service metrics]
. https://github.com/kubernetes/kube-state-metrics/blob/master/docs/statefulset-metrics.md[StatefulSet metrics]


 
 

== Verifying Kubernetes Checksums


The Cloud Insights agent installer performs integrity checks, but some users may want to perform their own verifications before installing or applying downloaded artifacts. To perform a download-only operation (as opposed to the default download-and-install), these users can edit the agent installation command obtained from the UI and remove the trailing “install” option.

Follow these steps:

. Copy the Agent Installer snippet as directed.
. Instead of pasting the snippet into a command window, paste it into a text editor.
. Remove the trailing “--install” from the command.
. Copy the entire command from the text editor.
. Now paste it into your command window (in a working directory) and run it.

* Download and install (default):

 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download –-install

* Download-only:

 installerName=cloudinsights-kubernetes.sh … && sudo -E -H ./$installerName --download


The download-only command will download all required artifacts from Cloud Insights to the working directory.  The artifacts include, but may not be limited to: 

* an installation script
* an environment file
* YAML files
* a signed checksum file (sha256.signed)
* a PEM file (netapp_cert.pem) for signature verification



The installation script, environment file, and YAML files can be verified using visual inspection. 



The PEM file can be verified by confirming its fingerprint to be the following:

// E5:FB:7B:68:C0:8B:1C:A9:02:70:85:84:C2:74:F8:EF:C7:BE:8A:BC

 1A918038E8E127BB5C87A202DF173B97A05B4996

More specifically,


 openssl x509 -fingerprint -sha1 -noout -inform pem -in netapp_cert.pem


The signed checksum file can be verified using the PEM file:

 openssl smime -verify -in sha256.signed -CAfile netapp_cert.pem -purpose any


Once all of the artifacts have been satisfactorily verified, the agent installation can be initiated by running:


 sudo -E -H ./<installation_script_name> --install


////
You can adjust the NetApp Kubernetes Monitoring Operator for optimal performance by fine-tuning certain variables for Custom Resources.  See the following tables for variables that you can set.

To modify these values, edit the agent CR with the following command (substituting <namespace> for your namespace): 

 kubectl edit agent agent-monitoring-netapp -n <namespace>  

The CR specification follows the format:

----
 - name: <plugin-name> 
   ... 
   substitutions: 
   - key: <variable-name> 
     value: <desired-value>  
     ... 
----

Items marked "yes" for "Included in default CR" will already be present in the agent CR and can be found under their respective plugin. Items marked "no" must be added manually following the examples provided by the included default substitutions.

=== Resource related variables 
See https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/	for information on Kubernetes Resources. 	

|===

|Variable Name	|Plugin Name	|Included in default CR	|Description

 
|DS_CPU_LIMITS_PLACEHOLDER	|agent	|yes	|Kubernetes CPU limit for telegraf-ds
|DS_MEM_LIMITS_PLACEHOLDER	|agent	|yes	|Kubernetes mem limit for telegraf-ds
|DS_CPU_REQUEST_PLACEHOLDER	|agent	|yes	|Kubernetes cpu requests for telegraf-ds
|DS_MEM_REQUEST_PLACEHOLDER	|agent	|yes	|Kubernetes memory requests for telegraf-ds
|RS_CPU_LIMITS_PLACEHOLDER	|agent	|yes	|Kubernetes CPU limit for telegraf-rs.
|RS_MEM_LIMITS_PLACEHOLDER	|agent	|yes	|Kubernetes mem limit for telegraf-rs
|RS_CPU_REQUEST_PLACEHOLDER	|agent	|yes	|Kubernetes cpu requests for telegraf-rs
|RS_MEM_REQUEST_PLACEHOLDER	|agent	|yes	|Kubernetes memory requests for telegraf-rs
|KSM_CPU_REQUEST_PLACEHOLDER:	|ksm	|yes	|Kubernetes cpu requests for kube-state-metrics deploy
|KSM_MEM_REQUEST_PLACEHOLDER:	|ksm	|yes	|Kubernetes cpu requests for kube-state-metrics deploy

|===

=== Telegraf related variables 
See https://github.com/influxdata/telegraf/blob/master/docs/CONFIGURATION.md#agent for information on telegraf variables.


|===


|Placeholder	|Plugin Name	|Included in default CR	|Description

|COLLECTION_INTERVAL_PLACEHOLDER	|agent|	no	|(sets telegraf interval, type interval): The default time telegraf will wait between inputs for all plugins. Valid time units are ns, us (or µs), ms, s, m, h.
|ROUND_INTERVAL_PLACEHOLDER	|agent	|no	|(sets telegraf round_interval, type boolean) collect metrics on multiples of interval
|METRIC_BATCH_SIZE_PLACEHOLDER	|agent	|no	|(sets telegraf metric_batch_size, type int) maximum number of records for an output telegraf will write in one batch
|METRIC_BUFFER_LIMIT_PLACEHOLDER	|agent	|no	|(sets telegraf metric_buffer_limit, type int) maximum number of records for an output telegraf will cache pending a successful write
|COLLECTION_JITTER_PLACEHOLDER	|agent	|no	|(sets telegraf collection_jitter, type interval): Each plugin will wait a random amount of time between the scheduled collection time and that time + collection_jitter before collecting inputs
|PRECISION_PLACEHOLDER	|agent	|no	|(sets telegraf precision, type interval): Collected metrics are rounded to the precision specified, when set to "0s" precision will be set by the units specified by interval
|FLUSH_INTERVAL_PLACEHOLDER	|agent	|no	|(sets telegraf flush_interval, type interval): Default time telegraf will wait between writing outputs.
|FLUSH_JITTER_PLACEHOLDER	|agent	|no	|(sets telegraf flush_jitter, type interval): Each output will wait a random amount of time between the scheduled write time and that time + flush_jitter before writing outputs

|===


=== Miscellaneous variables

|===

|Placeholder	|Plugin Name	|Included in default CR	|Description

|CURL_CMD_PLACEHOLDER	|agent	|yes	|The curl command used to download various resources. Ex) "curl" or "curl -k"
|===

////






== Troubleshooting

Some things to try if you encounter problems setting up the NetApp Kubernetes Monitoring Operator:

[cols="stretch", options="header"]
|===
|Problem:|Try this:


|I do not see a hyperlink/connection between my Kubernetes Persistent Volume and the corresponding back-end storage device. My Kubernetes Persistent Volume is configured using the hostname of the storage server.
|Follow the steps to uninstall the existing Telegraf agent, then re-install the latest Telegraf agent. You must be using Telegraf version 2.0 or later, and your Kubernetes cluster storage must be actively monitored by Cloud Insights.

|I'm seeing messages in the logs resembling the following:

E0901 15:21:39.962145 1 reflector.go:178] k8s.io/kube-state-metrics/internal/store/builder.go:352: Failed to list *v1.MutatingWebhookConfiguration: the server could not find the requested resource
E0901 15:21:43.168161 1 reflector.go:178] k8s.io/kube-state-metrics/internal/store/builder.go:352: Failed to list *v1.Lease: the server could not find the requested resource (get leases.coordination.k8s.io)
etc.


|These messages may occur if you are running kube-state-metrics version 2.0.0 or above with Kubernetes versions below 1.20.


To get the Kubernetes version:

 _kubectl version_

To get the kube-state-metrics version:

 _kubectl get deploy/kube-state-metrics -o jsonpath='{..image}'_

To prevent these messages from happening, users can modify their kube-state-metrics deployment to disable the following Leases:

_mutatingwebhookconfigurations_
_validatingwebhookconfigurations_
_volumeattachments resources_

More specifically, they can use the following CLI argument:

resources=certificatesigningrequests,configmaps,cronjobs,daemonsets, deployments,endpoints,horizontalpodautoscalers,ingresses,jobs,limitranges, namespaces,networkpolicies,nodes,persistentvolumeclaims,persistentvolumes, poddisruptionbudgets,pods,replicasets,replicationcontrollers,resourcequotas, secrets,services,statefulsets,storageclasses

The default resource list is:

"certificatesigningrequests,configmaps,cronjobs,daemonsets,deployments, endpoints,horizontalpodautoscalers,ingresses,jobs,leases,limitranges, mutatingwebhookconfigurations,namespaces,networkpolicies,nodes, persistentvolumeclaims,persistentvolumes,poddisruptionbudgets,pods,replicasets, replicationcontrollers,resourcequotas,secrets,services,statefulsets,storageclasses, validatingwebhookconfigurations,volumeattachments"


|I see error messages from Telegraf resembling the following, but Telegraf does start up and run:

Oct 11 14:23:41 ip-172-31-39-47 systemd[1]: Started The plugin-driven server agent for reporting metrics into InfluxDB.
Oct 11 14:23:41 ip-172-31-39-47 telegraf[1827]: time="2021-10-11T14:23:41Z" level=error msg="failed to create cache directory. /etc/telegraf/.cache/snowflake, err: mkdir /etc/telegraf/.ca
che: permission denied. ignored\n" func="gosnowflake.(*defaultLogger).Errorf" file="log.go:120"
Oct 11 14:23:41 ip-172-31-39-47 telegraf[1827]: time="2021-10-11T14:23:41Z" level=error msg="failed to open. Ignored. open /etc/telegraf/.cache/snowflake/ocsp_response_cache.json: no such
file or directory\n" func="gosnowflake.(*defaultLogger).Errorf" file="log.go:120"
Oct 11 14:23:41 ip-172-31-39-47 telegraf[1827]: 2021-10-11T14:23:41Z I! Starting Telegraf 1.19.3

|This is a known issue.  Refer to link:https://github.com/influxdata/telegraf/issues/9407[This GitHub article] for more details. As long as Telegraf is up and running, users can ignore these error messages.

|On Kubernetes, my Telegraf pod(s) are reporting the following error:
"Error in processing mountstats info: failed to open mountstats file: /hostfs/proc/1/mountstats, error: open /hostfs/proc/1/mountstats: permission denied"
|If SELinux is enabled and enforcing, it is likely preventing the Telegraf pod(s) from accessing the /proc/1/mountstats file on the Kubernetes nodes.  To relax this restriction, edit the agent (`kubectl edit agent agent-monitoring-netapp`), and change "privileged-mode: false" to "privileged-mode: true"


|On Kubernetes, my Telegraf ReplicaSet pod is reporting the following error:

 [inputs.prometheus] Error in plugin: could not load keypair /etc/kubernetes/pki/etcd/server.crt:/etc/kubernetes/pki/etcd/server.key: open /etc/kubernetes/pki/etcd/server.crt: no such file or directory
|The Telegraf ReplicaSet pod is intended to run on a node designated as a master or for etcd. If the ReplicaSet pod is not running on one of these nodes, you will get these errors. Check to see if your master/etcd nodes have taints on them. If they do, add the necessary tolerations to the Telegraf ReplicaSet, telegraf-rs.

For example, edit the ReplicaSet...

 kubectl edit rs telegraf-rs

...and add the appropriate tolerations to the spec. Then, restart the ReplicaSet pod.

|I have a PSP/PSA environment. Does this affect my monitoring operator?
|If your Kubernetes cluster is running with Pod Security Policy (PSP) or Pod Security Admission (PSA) in place, you must upgrade to the latest NetApp Kubernetes Monitoring Operator. Follow these steps to upgrade to the current NKMO with support for PSP/PSA:

1. <<uninstalling,Uninstall>> the previous monitoring operator:

 kubectl delete agent agent-monitoring-netapp -n netapp-monitoring
 kubectl delete ns netapp-monitoring
 kubectl delete crd agents.monitoring.netapp.com
 kubectl delete clusterrole agent-manager-role agent-proxy-role agent-metrics-reader
 kubectl delete clusterrolebinding agent-manager-rolebinding agent-proxy-rolebinding agent-cluster-admin-rolebinding

2. <<installing-the-netapp-kubernetes-monitoring-operator, Install>> the latest version of the monitoring operator.

|I ran into issues trying to deploy the NKMO, and I have PSP/PSA in use.
|1. Edit the agent using the following command:

kubectl -n <name-space> edit agent

2. Mark 'security-policy-enabled' as 'false'. This will disable Pod Security Policies and Pod Security Admission and allow the NKMO to deploy. Confirm by using the following commands:

kubectl get psp (should show Pod Security Policy removed)
kubectl get all -n <namespace> \| grep -i psp (should show that nothing is found) 

|"ImagePullBackoff" errors seen
|These errors may be seen if you have a custom or private docker repository and have not yet configured the NetApp Kubernetes Monitoring Operator to properly recognize it.  <<using-a-custom-or-private-docker-repository,Read more>> about configuring for custom/private repo.


|I am having an issue with my monitoring-operator deployment, and the current documentation does not help me resolve it.
a|Capture or otherwise note the output from the following commands, and contact the Technical Support team.

----
 kubectl -n netapp-monitoring get all
 kubectl -n netapp-monitoring describe all
 kubectl -n netapp-monitoring logs <monitoring-operator-pod> --all-containers=true
 kubectl -n netapp-monitoring logs <telegraf-pod> --all-containers=true
----


|===

Additional information may be found from the link:concept_requesting_support.html[Support] page or in the link:https://docs.netapp.com/us-en/cloudinsights/CloudInsightsDataCollectorSupportMatrix.pdf[Data Collector Support Matrix].


