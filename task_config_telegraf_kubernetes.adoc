---
sidebar: sidebar
permalink: task_config_telegraf_kubernetes.html
keywords: telegraf, installation, install, kubernetes
summary: Kubernetes data collector configuration
---

= Kubernetes Data Collector

:toc: macro
:hardbreaks:
:toclevels: 1
:nofooter:
:icons: font
:linkattrs:
:imagesdir: ./media/

[.lead]
Cloud Insights uses this data collector to gather metrics from Kubernetes.

== Installation

TIP: It is strongly recommended to deploy the Telegraf agent as a DaemonSet within the Kubernetes environment itself, by selecting _Kubernetes_ as the platform during agent installation.

. From *Admin > Data Collectors*, click *+Data Collector*. Under *Services*, choose Kubernetes.
+
Select the Operating System or Platform on which the Telegraf agent is installed. 

. If you haven't already installed an Agent for collection, or you wish to install an Agent for a different Operating System or Platform, click _Show Instructions_ to expand the link:task_config_telegraf_agent.html[Agent installation] instructions.

. Select the Agent Access Key for use with this data collector. You can add a new Agent Access Key by clicking the *+ Agent Access Key* button. Best practice: Use a different Agent Access Key only when you want to group data collectors, for example, by OS/Platform.

. Follow the configuration steps to configure the data collector. The instructions vary depending on the type of Operating System or Platform you are using to collect data. 

image:KubernetesDCConfigKube.png[Kubernetes configuration]

== Setup
The Telegraf input plugin for Kubernetes collects metrics through the /stats/summary endpoint of the kubelet REST API.

==== Compatibility
Configuration was developed against Kubernetes version 1.9.1.

==== Configuring an Agent to Collect Data from Kubernetes

For Kubernetes environments, Cloud Insights deploys the Telegraf agent as a DaemonSet. The pods in which the agents run need to have access to the following:

* hostPath
* configMap
* secrets

These Kubernetes objects are automatically created as part of the Kubernetes agent install command provided in the Cloud Insights UI. Some variants of Kubernetes, such as OpenShift, implement an added level of security that may block access to these components. The _SecurityContextConstraint_ is not created as part of the Kubernetes agent install command provided in the Cloud Insights UI, and must be created manually. Once created, restart the Telegraf pod(s).

//In such cases, an additional manual step may be required.  As an example, for OpenShift, you may need to create a _SecurityContextConstraint_ to grant the telegraf-user ServiceAccount access to these components.

----
    apiVersion: v1
    kind: SecurityContextConstraints
    metadata:
      name: telegraf-hostaccess
      creationTimestamp:
      annotations:
        kubernetes.io/description: telegraf-hostaccess allows hostpath volume mounts for restricted SAs.
      labels:
        app: ci-telegraf
    priority: 10
    allowPrivilegedContainer: false
    defaultAddCapabilities: []
    requiredDropCapabilities: []
    allowedCapabilities: []
    allowedFlexVolumes: []
    allowHostDirVolumePlugin: true
    volumes:
    - hostPath
    - configMap
    - secret
    allowHostNetwork: false
    allowHostPorts: false
    allowHostPID: false
    allowHostIPC: false
    seLinuxContext:
      type: MustRunAs
    runAsUser:
      type: RunAsAny
    supplementalGroups:
      type: RunAsAny
    fsGroup:
      type: RunAsAny
    readOnlyRootFilesystem: false
    users:
    - system:serviceaccount:monitoring:telegraf-user
    groups: []
----
    
==== Setting Up

For collecting Kubernetes metrics, the best practice is to deploy the Telegraf agent as a DaemonSet within the Kubernetes environment of interest itself. The Cloud Insights agent install command does this if run on one of the Kubernetes nodes in the cluster. With the DaemonSet that is created, you can simply specify the "$HOSTIP" environment variable for <INSERT_KUBELET_ADDRESS> in the telegraf-conf ConfigMap. 

The pods in which the Telegraf agents run need to have access to a valid Kubernetes access token file in order to use the required kubelet API. To configure a Telegraf agent running outside the Kubernetes cluster of interest, you must manually generate this Kubernetes access token file, and configure the Telegraf agent to use this access token file.

To manually generate the Kubernetes access token, run the following in a Bash shell:

 SECRET=$(sudo kubectl --namespace kube-system describe sa default |grep Tokens |awk '{print $2}')

 TOKEN=$(sudo kubectl --namespace kube-system describe secrets $SECRET |grep ^token |awk '{print $2}')

To verify that the access token works as needed, run the following to confirm the kubelet API is accessible:

 curl -v -X GET -H "Authorization: Bearer $TOKEN" https://10.197.122.81:10250/stats/summary

To create the required access token file, run the following:

 mkdir -p /var/run/secrets/kubernetes.io/serviceaccount/

 echo -n $TOKEN | sudo tee /var/run/secrets/kubernetes.io/serviceaccount/token

By default, the Kubernetes input plugin configuration provided by CloudInsights is set up to look for the required access token file in the location used above. After performing the steps above, restart the Telegraf agent for the changes to take effect.

== Objects and Counters

The following objects and their counters are collected:

[cols="<.<,<.<,<.<,<.<"]
|===
|Object:|Identifiers:|Attributes: |Datapoints:

|K8s Container

|Namespace
Pod
Container
Cluster

|Kubernetes Node

|CPU Nanoseconds
Memory Major Page Faults
Memory Resident Set Size (RSS)
Memory Working Set
Root Filesystem Available
Root Filesystem Capacity
Root Filesystem Used

|Kubernetes Node

|Kubernetes Node
Cluster

|
|CPU Used Nanocores
CPU Used Nanoseconds
Filesystem Available
Filesystem Total
Filesystem Used
Memory Available
Memory Major Page Faults
Memory Page Faults
Memory Resident Set Size (RSS)
Memory Working Set
Network RX Errors (per sec)
Network RX Bytes (per sec)
Network TX Errors (per sec)
Network TX Bytes (per sec)
Image Filesystem Available
Image Filesystem Used

|Kubernetes Pod

|Namespace
Pod
Cluster

|Kubernetes Node
Node Name
Node IP

|Network TX Bytes (per sec)
Network TX Errors (per sec)
Network RX Bytes (per sec)
Network RX Errors (per sec)
|===

== Troubleshooting

[cols=2*, options="header", cols"50,50"]
|===
|Problem:|Try this:
|I ran the Kubernetes agent installer command, but I do not see a Telegraf agent pod running via:

 sudo kubectl --namespace monitoring get pods

|Check if there were any errors deploying the DaemonSet:

 sudo kubectl --namespace monitoring describe ds telegraf-ds

If there are errors related to SecurityContextConstraints, do the following:

1. Generate the Telegraf DaemonSet YAML

 sudo kubectl --namespace monitoring get ds telegraf-ds -o yaml > /tmp/telegraf-ds.yaml

2. Stop the Telegraf service

 sudo kubectl --namespace monitoring delete ds telegraf-ds

3. Create the necessary SecurityContextConstraint (see "Configuring Agent to Collect Data" section)

4. Re-create the Telegraf DaemonSet
|I configured Telegraf to obtain information about my Kubernetes cluster, but I don't see any information in Cloud Insights. I see "invalid header field value" errors in the Telegraf log file pertaining to the kubernetes input plugin I configured. 
|Ensure the referenced bearer_token file does not have a trailing newline. To verify, run the following command, and confirm that it returns 0: 

 tail -c1 <bearer_token_file> |wc -l
 
|===

Additional information may be found from the link:concept_requesting_support.html[Support] page.
